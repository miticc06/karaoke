sudo: required

language: node_js
node_js:
- 11

before_script:
- openssl aes-256-cbc -K $encrypted_624b4ed64e85_key -iv $encrypted_624b4ed64e85_iv -in deploy_rsa.enc -out deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 deploy_rsa
- ssh-add deploy_rsa
- echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

install:
- yarn

stages:
- Build
- Deploy
jobs:
  include:
  - stage: Build
    script:
      - CI=false yarn build
      - ssh -p 22 deploy@dev1.kienthuc24h.com "/bin/mkdir -p /home/deploy/karaoke-frontend"
      - rsync -a -e "ssh -p 22" ./ deploy@dev1.kienthuc24h.com:/home/deploy/karaoke-frontend/ --delete --exclude="node_modules"

  - stage: Deploy
    script:
      - ls
      - ssh -p 22 deploy@dev1.kienthuc24h.com "chmod 700 /home/deploy/karaoke-frontend/start.sh"
      - ssh -p 22 deploy@dev1.kienthuc24h.com "/home/deploy/karaoke-frontend/start.sh"
    on:
      branch: master
      
# deploy: 
#   provider: script
#   script:
#     - ssh -p 22 deploy@dev1.kienthuc24h.com "/bin/mkdir -p /home/deploy/commit"
#     - rsync -a -e "ssh -p 22" build/ deploy@dev1.kienthuc24h.com:/home/deploy/commit/${COMMIT_TIME} --delete
#   on:
#     all_branches: true
